import{d as M,k as E,r as G,b as H,s as O,o as F,x as B,S as N,a3 as W,t as $,A as Y,f as V,u as P,ac as L,U as j,V as z,ab as q}from"./vue-db0e7353.js";import"./dayjs-4778c158.js";import{bv as y,bh as J,bi as K,W as Q,ae as X,Y as Z}from"./index-a3873c66.js";import{C as R,B as ee,b as te,D as S,V as ae,A as oe,W as se,c as k,d as ne,e as re,f as ie,F as A,h as _}from"./device-f2176f90.js";class I extends R{async _connect(){const e=new WebSocket(this.url);return this.ws=e,e.binaryType="arraybuffer",new Promise((n,a)=>{e.onerror=a,e.onopen=()=>{n(new ReadableStream({start:t=>{e.onclose=r=>t.error(r),e.onmessage=r=>t.enqueue(r.data)}}))}})}_close(){var e;(e=this.ws)==null||e.close(1e3,"close")}_send(e){var n;(n=this.ws)==null||n.send(e)}}class ce extends R{async _connect(){const e=await fetch(this.url,{...this.options.requestInit,signal:this.abortCtrl.signal});if(!e.body)throw new Error("no body");return e.body}}const de=442,le=443,ue=444,he=480,fe=448,me=445,we=441,be=27,ge=36,pe=15,Se=144,Ce=145;class ye extends ee{constructor(){super(...arguments),this.videoStreamType=0,this.audioStreamType=0,this.pts=0,this.dts=0}pull(){throw new Error("Method not implemented.")}*demux(){var c,i,l,u,m;let e=0;const n=new Uint8Array(4),a=new DataView(n.buffer),t=[];let r=0,o=0;for(;;){yield n;const h=a.getUint32(0);switch(h.toString(16),h){case de:yield 9,yield n.subarray(0,1),yield a.getUint8(0)&7;break;case le:case me:yield n.subarray(0,2),yield a.getUint16(0);break;case ue:yield n.subarray(0,2);const b=yield a.getUint16(0);this.decProgramStreamMap(b);break;case he:yield n.subarray(0,2);const d=a.getUint16(0),C=yield d,g=this.parsePESPacket(C);if(g.length,!e)if((g[4]&15)==7)e=Date.now(),o=this.pts;else break;if(o==this.pts){r+=g.length,t.push(g.slice());break}if(t.length&&o!=this.pts){let p=0;(c=this.gotVideo)==null||c.call(this,{type:(t[0][4]&15)==1?"delta":"key",data:t.length==1?t[0]:t.reduce((T,U)=>(T.subarray(p).set(U),p+=U.length,T),new Uint8Array(r)),timestamp:(Date.now()-e)*1e3}),t.length=0}r+=g.length,t.push(g.slice()),o=this.pts;break;case fe:yield n.subarray(0,2);const x=yield a.getUint16(0),D=this.parsePESPacket(x);if(((i=this.audioDecoderConfig)==null?void 0:i.codec)=="aac"&&!((l=this.audioDecoderConfig)!=null&&l.description)){const p=te(D.subarray(7));this.audioDecoderConfig={codec:"aac",description:p.audioSpecificConfig,sampleRate:p.sampleRate,numberOfChannels:p.channel},this.emit(S.AUDIO_ENCODER_CONFIG_CHANGED,this.audioDecoderConfig)}(m=this.gotAudio)==null||m.call(this,{type:"key",data:((u=this.audioDecoderConfig)==null?void 0:u.codec)=="aac"?D.subarray(7):D,timestamp:this.dts,duration:0});break;case we:return;default:debugger}}}parsePESPacket(e){if(e.length<4)throw new Error("Short buffer");const n=e[1],a=n>>7==1,t=(n&64)>>6==1,r=e[2];if(e.length<r+3)throw new Error("Short buffer");const o=e.subarray(3,3+r);return a&&o.length>4&&(this.pts=(o[0]&14)<<29|o[1]<<22|(o[2]&254)<<14|o[3]<<7|o[4]>>1,t&&o.length>9?this.dts=(o[5]&14)<<29|o[6]<<22|(o[7]&254)<<14|o[8]<<7|o[9]>>1:this.dts=this.pts),e.subarray(3+r)}decProgramStreamMap(e){const n=new DataView(e.buffer,e.byteOffset,e.byteLength),a=e.length;let t=2;const r=n.getUint16(t);t+=2,t+=r;let o=n.getUint16(t);for(t+=2;o>0&&!(a<=t+1);){const c=e[t];t++;const i=e[t];if(t++,i>=224&&i<=239?(this.videoStreamType=c,this.videoDecoderConfig={codec:{[be]:"avc",[ge]:"hevc"}[c]||"unknown"},this.emit(S.VIDEO_ENCODER_CONFIG_CHANGED,this.videoDecoderConfig)):i>=192&&i<=223&&(this.audioStreamType=c,this.audioDecoderConfig={codec:{[pe]:"aac",[Se]:"pcma",[Ce]:"pcmu"}[c]||"unknown",numberOfChannels:1,sampleRate:8e3},this.audioDecoderConfig.codec!="aac"&&this.emit(S.AUDIO_ENCODER_CONFIG_CHANGED,this.audioDecoderConfig)),a<=t+1)break;const l=n.getUint16(t);t+=2,t+=l,o-=4+l}}}const _e={class:"video-container"},ve=["srcObject"],De=M({__name:"jb4",props:{streamPath:null,format:null,title:null,webrtcStream:null},setup(f){const e=f,n=()=>document.querySelector(".video-container");let a;const t=E();let r,o;const c=E(),i=new ae,l=new oe,u=G(new se(""));i.on(k.VideoCodecInfo,s=>{}),i.on(k.VideoFrame,s=>{o.write(s)}),l.on(ne.AudioFrame,s=>{r.write(s)}),i.on(k.Error,s=>{console.error(s)});function m(){var s;t.value&&((s=e.webrtcStream)!=null&&s.mediaStream)&&(c.value=e.webrtcStream.mediaStream)}H(()=>{var s;(s=e.webrtcStream)==null||s.off("change",m)}),O(()=>{u.mediaStream&&(c.value=u.mediaStream),e.webrtcStream&&(m(),e.webrtcStream.on("change",m))}),O(async()=>{if(e.streamPath&&e.format){switch(a&&(i.close(),l.close(),await a.close()),await i.initialize(),await l.initialize(),e.format){case"ps":a=new I(`${y("ps","","ws")}/${e.streamPath}`),h(new ye(a,_.PUSH));break;case"http-flv":a=new ce(`${y("hdl","")}/${e.streamPath}.flv`),h(new A(a,_.PUSH));break;case"ws-flv":a=new I(`${y("jessica","","ws")}/${e.streamPath}.flv`),h(new A(a,_.PUSH));break;case"webrtc":const s=new re(`${y("webrtc","/play")}/${e.streamPath}`);a=s;const w=s.webrtc;u.id=e.streamPath,s.addStream(u),w.ondatachannel=b=>{const d=b.channel,C=new ie(d);h(new A(C,_.PUSH)),C.connect()};break}await a.connect()}});function h(s){const w=new MediaStreamTrackGenerator({kind:"audio"});r=w.writable.getWriter();const b=new MediaStreamTrackGenerator({kind:"video"});o=b.writable.getWriter(),c.value=new MediaStream([w,b]),s.on(S.VIDEO_ENCODER_CONFIG_CHANGED,d=>{i.configure(d)}),s.on(S.AUDIO_ENCODER_CONFIG_CHANGED,d=>{l.configure(d)}),s.gotVideo=d=>i.decode(d),s.gotAudio=d=>l.decode(d)}const v=E(!0);return F(()=>{J(t.value,"canplay",()=>{v.value=!1})}),B(()=>a==null?void 0:a.close()),(s,w)=>(N(),W("div",_e,[$(V(P(K),{class:"loading",size:"large"},null,512),[[Y,v.value]]),L("video",{ref_key:"videoEle",ref:t,class:"video",srcObject:c.value,autoplay:""},null,8,ve),f.title?(N(),j(P(X),{key:0,class:"info",title:f.title,getPopupContainer:n},{default:z(()=>[V(P(Q),{icon:"octicon:ellipsis-16",size:20,color:"#dedede",hoverColor:"#9dcefc"})]),_:1},8,["title"])):q("",!0)]))}});const Ue=Z(De,[["__scopeId","data-v-6c1fd2be"]]);export{Ue as V};
