import{f as t,d as L,k as H,s as G,e as N,U as K,V as $,$ as n,u as e,E as j,F as z}from"./vue-c6b19427.js";import{u as P}from"./formily-616f199b.js";import{T,aI as h,aJ as g,al as W,Y,ao as J,am as Q,B as X,ap as Z}from"./index-5bf97ded.js";import{a as ee,u as te}from"./index-9bf17547.js";import"./dayjs-4778c158.js";import{_ as re}from"./scroll-tip.vue_vue_type_script_setup_true_lang-951434a5.js";import{u as oe}from"./device-dfd9cfe9.js";import{C as v}from"./Card-02b71e3c.js";import{a as se,T as f}from"./useFlexGapSupport-dcef435e.js";import{S as ae}from"./index-ae1d50c1.js";import"./index-c694a60c.js";import"./index-f54b9088.js";import"./Group-ff43945e.js";import"./index-b96f56b2.js";import"./index-864acc37.js";import"./mockjs-890b569b.js";import"./gb28281-d411f3dc.js";const ne=(r,s)=>({type:"object",properties:{layout:{type:"void","x-component":"FormLayout","x-component-props":{layout:"inline"},properties:{Name:{type:"string","x-decorator":"FormItem","x-decorator-props":{style:"margin-right: 10px;width: 260px"},"x-component":"Input","x-component-props":{placeholder:"请输入流标识或源地址搜索","@keyup":r},"x-content":{prefix:()=>t(T,{icon:"ic:outline-search"},null)}},add:{type:"void","x-component":"Button","x-component-props":{"@click":()=>s()},"x-content":{default:"添加拉流转发",icon:()=>t(T,{icon:"ant-design:plus-outlined",class:"v-text-bottom mr-4px"},null)}}}}}}),le=()=>({type:"object",properties:{layout:{type:"void","x-component":"FormLayout","x-component-props":{layout:"horizontal",labelCol:6,wrapperCol:14},properties:{type:{type:"boolean",title:"协议",description:"拉流协议","x-decorator":"FormItem","x-component":"Radio.Group",enum:[{label:"hdl",value:"hdl"},{label:"rtmp",value:"rtmp"},{label:"rtsp",value:"rtsp"},{label:"hls",value:"hls"}],"x-component-props":{optionType:"button"},default:"hdl",required:!0},streamPath:{type:"string",title:"流标识",description:"拉流进入m7s后的流地址","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:"请输入 m7s 流标识，如：live/test",allowClear:!0},required:!0},target:{type:"string",title:"源地址","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:"请输入源地址",allowClear:!0},"x-reactions":{dependencies:["type"],fulfill:{schema:{description:"{{ targetDescMap[$deps[0]] }}"}}},required:!0},encode:{type:"boolean",title:"源地址编码",description:"源地址包含特殊字符时需要开启编码","x-decorator":"FormItem","x-component":"Switch","x-component-props":{checkedChildren:"是",unCheckedChildren:"否"}}}}}}),C=h({requestOptions:{apiUrl:()=>g("hdl")}});function b(r){return C.get({url:"/pull",params:r},{errorMessageMode:"message"})}function w(){return C.get({url:"/list"},{errorMessageMode:"message"})}const O=h({requestOptions:{apiUrl:()=>g("rtmp")}});function ie(r){return O.get({url:"/pull",params:r},{errorMessageMode:"message"})}function pe(){return O.get({url:"/list"},{errorMessageMode:"message"})}const R=h({requestOptions:{apiUrl:()=>g("rtsp")}});function ce(r){return R.get({url:"/pull",params:r},{errorMessageMode:"message"})}function ue(){return R.get({url:"/list"},{errorMessageMode:"message"})}const F=h({requestOptions:{apiUrl:()=>g("hls")}});function me(r){return F.get({url:"/pull",params:r},{errorMessageMode:"message"})}function de(){return F.get({url:"/list"},{errorMessageMode:"message"})}const{FormilyForm:fe,form:he,submit:ge}=P({schema:le(),scope:{targetDescMap:{hdl:"远端的 http-flv 的地址，若包含特殊字符需要执行编码",rtmp:"远端的 rtmp 的地址，若包含特殊字符需要执行编码",rtsp:"远端的 rtsp 的地址，若包含特殊字符需要执行编码",hls:"远端的 m3u8 的地址，若包含特殊字符需要执行编码"}}}),xe=r=>{switch(r){case"hdl":return b;case"rtmp":return ie;case"rtsp":return ce;case"hls":return me;default:return b}},ye=({updateList:r,pause:s,resume:c})=>{s(),ee({content:()=>t(fe,null,null),modalConfig:{title:"添加拉流转发",maskClosable:!1,width:700,onOk:async()=>{const{streamPath:u,target:l,type:x,encode:i}=await ge();return u?(await xe(x)({streamPath:u,target:i?encodeURIComponent(l):l}),W.success("已启动拉流!"),r(),Promise.resolve(!0)):(c(),Promise.reject(!1))},onClose:()=>{he.reset(),c()}}})},_e=L({name:"StreamProxy"}),Be=L({..._e,setup(r){const s=H("hdl"),c=o=>{switch(o){case"hdl":return w;case"rtmp":return pe;case"rtsp":return ue;case"hls":return de;default:return w}};G(()=>{m()});const u=oe(),l=N(()=>u.deviceList),{httpRefreshTime:x}=Y({VITE_PORT:"3000",VITE_GLOB_APP_TITLE:"Monibuca Admin",VITE_GLOB_APP_SHORT_NAME:"m7s_admin",VITE_USE_MOCK:"true",VITE_PUBLIC_PATH:"/ui",VITE_DROP_CONSOLE:"true",VITE_BUILD_COMPRESS:"none",VITE_BUILD_COMPRESS_DELETE_ORIGIN_FILE:"false",VITE_GLOB_HTTP_REFRESH_TIME:"5000",VITE_USE_IMAGEMIN:"true",VITE_LEGACY:"false",VITE_M7S_SERVER:"",BASE_URL:"/ui",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),{pause:i,resume:y}=J(m,x),V=o=>{const a=String(o.target.value).trim().toLowerCase();if(a){const d=new RegExp(a,"gi"),M=["ID","Name"],A=l.value.filter(E=>M.some(p=>String(E[p]).toLowerCase().indexOf(a)>-1)).map(E=>{const p=Object.assign({},E);return M.forEach(S=>{p[S]=String(p[S]).replace(d,q=>`<span style="color: #ff99a0">${q}</span>`)}),p});_(A),i()}else _(l.value),y()},D=()=>{ye({updateList:m,pause:i,resume:y})},{FormilyForm:U}=P({schema:ne(V,D)}),k={toggleRowExpand:({expanded:o})=>{o?i():y()}},I=te(),_=o=>{I.tableRef.reloadData(o||[])};function m(){return c(s.value)().then(o=>{_(o)}).catch(o=>{console.error(`stream-proxy-getList-error: ${o}`)})}m();const B={maxHeight:"100%",rowConfig:{keyField:"ID",useKey:!0},columnConfig:{useKey:!0},columns:[{field:"StreamPath",title:"流标识",showOverflow:"tooltip",width:"200px",fixed:"left",type:"html"},{field:"URL",title:"源地址",showOverflow:"tooltip",width:"120px",type:"html"},{field:"StartTime",title:"开始时间",minWidth:"180px",formatter:({cellValue:o})=>Z.toDateString(new Date(o),"yyyy-MM-dd HH:ss:mm")},{field:"operate",title:"操作",width:"120px",fixed:"right",align:"center",slots:{default:"operate"}}],data:[]};return(o,a)=>(K(),$(z,null,[t(e(v),{bordered:!1,bodyStyle:{padding:"26px 10px 0 10px",marginBottom:"8px"}},{default:n(()=>[t(e(U))]),_:1}),t(e(v),{bordered:!1,bodyStyle:{padding:"10px",height:"calc(100% - 50px)"},style:{height:"calc(100% - 100px)"}},{default:n(()=>[t(e(re),{windowWidth:1716}),t(e(se),{activeKey:s.value,"onUpdate:activeKey":a[0]||(a[0]=d=>s.value=d)},{default:n(()=>[t(e(f),{key:"hdl",tab:"hdl"}),t(e(f),{key:"rtmp",tab:"rtmp"}),t(e(f),{key:"rtsp",tab:"rtsp"}),t(e(f),{key:"hls",tab:"hls"})]),_:1},8,["activeKey"]),t(e(Q),{uid:e(I).uid,gridOptions:e(B),gridEvent:e(k)},{operate:n(({row:d})=>[t(e(ae),null,{default:n(()=>[t(e(X),{size:"small",type:"link"},{default:n(()=>[j(" 测试 ")]),_:1})]),_:1})]),_:1},8,["uid","gridOptions","gridEvent"])]),_:1},8,["bodyStyle"])],64))}});export{Be as default};
